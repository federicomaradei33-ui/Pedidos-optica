<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Óptica Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; }
        .glass-card { background: white; border-radius: 1.25rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); padding: 1.5rem; border: 1px solid #e2e8f0; }
        .input-style { @apply w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition-all bg-gray-50 focus:bg-white; }
        #loader { position: fixed; inset: 0; background: white; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .btn-primary { @apply w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition-all disabled:opacity-50; }
    </style>
</head>
<body>

    <div id="loader">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600"></div>
        <p class="mt-4 font-semibold text-gray-500 text-sm tracking-widest">ÓPTICA CONNECT</p>
    </div>

    <nav class="bg-white/80 backdrop-blur-md border-b sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 p-1.5 rounded-lg text-white"><i class="fas fa-glasses"></i></div>
                <span class="font-bold text-lg">Connect<span class="text-blue-600">Admin</span></span>
            </div>
            <div class="flex gap-6">
                <button onclick="switchTab('new')" class="text-sm font-bold text-gray-600 hover:text-blue-600 transition-colors">Nuevo</button>
                <button onclick="switchTab('history')" class="text-sm font-bold text-gray-600 hover:text-blue-600 transition-colors">Historial</button>
            </div>
        </div>
    </nav>

    <main class="max-w-3xl mx-auto p-6">
        
        <!-- Pestaña Nuevo Pedido -->
        <div id="tab-new" class="space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">Nueva Orden</h1>
                    <p class="text-gray-500 text-sm">Complete los datos para enviar al laboratorio.</p>
                </div>
                <div class="bg-white border px-4 py-2 rounded-xl shadow-sm text-center">
                    <span class="block text-[10px] font-bold text-gray-400 uppercase">Orden ID</span>
                    <span id="order-id-display" class="font-mono font-bold text-blue-600 text-lg">----</span>
                </div>
            </div>

            <form id="orderForm" class="space-y-6">
                <!-- Datos Personales -->
                <div class="glass-card">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-user-circle"></i> Paciente
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input type="text" id="patient_name" placeholder="Nombre completo del cliente" class="input-style" required>
                        <input type="text" id="patient_id" placeholder="DNI o Documento" class="input-style">
                    </div>
                </div>

                <!-- Receta -->
                <div class="glass-card">
                    <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                        <i class="fas fa-file-medical"></i> Graduación
                    </h2>
                    <div class="grid grid-cols-3 md:grid-cols-5 gap-3 mb-4 text-center">
                        <div class="hidden md:block"></div>
                        <div class="text-[10px] font-bold text-gray-400">ESF</div>
                        <div class="text-[10px] font-bold text-gray-400">CIL</div>
                        <div class="text-[10px] font-bold text-gray-400">EJE</div>
                        <div class="text-[10px] font-bold text-gray-400">ADD</div>
                    </div>
                    <div class="space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center">
                            <span class="text-xs font-bold text-blue-600">O. DERECHO</span>
                            <input type="text" id="od_esf" placeholder="ESF" class="input-style py-2 text-center">
                            <input type="text" id="od_cil" placeholder="CIL" class="input-style py-2 text-center">
                            <input type="text" id="od_eje" placeholder="EJE" class="input-style py-2 text-center">
                            <input type="text" id="od_add" placeholder="ADD" class="input-style py-2 text-center">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-3 items-center border-t pt-4">
                            <span class="text-xs font-bold text-blue-600">O. IZQUIERDO</span>
                            <input type="text" id="oi_esf" placeholder="ESF" class="input-style py-2 text-center">
                            <input type="text" id="oi_cil" placeholder="CIL" class="input-style py-2 text-center">
                            <input type="text" id="oi_eje" placeholder="EJE" class="input-style py-2 text-center">
                            <input type="text" id="oi_add" placeholder="ADD" class="input-style py-2 text-center">
                        </div>
                    </div>
                </div>

                <!-- Detalles Lente -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Tipo de Lente</h3>
                        <select id="lens_type" class="input-style mb-4">
                            <option>Monofocal Stock</option>
                            <option>Monofocal Laboratorio</option>
                            <option>Bifocal</option>
                            <option>Multifocal Progresivo</option>
                        </select>
                        <div class="space-y-3 px-1">
                            <label class="flex items-center gap-3 text-sm cursor-pointer"><input type="checkbox" class="t-check w-4 h-4" value="Antirreflex"> Antirreflex</label>
                            <label class="flex items-center gap-3 text-sm cursor-pointer"><input type="checkbox" class="t-check w-4 h-4" value="Filtro Azul"> Filtro Azul</label>
                            <label class="flex items-center gap-3 text-sm cursor-pointer"><input type="checkbox" class="t-check w-4 h-4" value="Fotocromático"> Fotocromático</label>
                        </div>
                    </div>
                    <div class="glass-card">
                        <h3 class="text-xs font-bold text-gray-400 uppercase mb-4">Armazón</h3>
                        <input type="text" id="frame_details" placeholder="Modelo / Color / Marca" class="input-style mb-4">
                        <select id="frame_job" class="input-style">
                            <option>Calibrado Metal</option>
                            <option>Calibrado Zilo</option>
                            <option>Ranurado</option>
                        </select>
                    </div>
                </div>

                <div class="glass-card">
                    <textarea id="notes" class="input-style h-24 mb-4" placeholder="Observaciones adicionales para el taller..."></textarea>
                    <button type="submit" id="submitBtn" class="btn-primary">
                        ENVIAR PEDIDO AL MAIL
                    </button>
                </div>
            </form>
        </div>

        <!-- Pestaña Historial -->
        <div id="tab-history" class="hidden space-y-4">
            <h1 class="text-2xl font-bold mb-6">Pedidos Registrados</h1>
            <div id="history-container" class="space-y-3"></div>
        </div>

    </main>

    <script>
        // CONFIGURACIÓN OBTENIDA DE TUS CAPTURAS
        const CONFIG = {
            USER_ID: "-NKT0dntx3JOPXYAA",
            SERVICE_ID: "service_bo6kzuc",
            TEMPLATE_ID: "template_4e00pyr",
            MY_EMAIL: "federicomaradei33@gmail.com" // Asegura que el destinatario sea tu mail
        };

        let orders = JSON.parse(localStorage.getItem('optica_v3_data')) || [];

        window.onload = () => {
            emailjs.init(CONFIG.USER_ID);
            updateOrderID();
            renderHistory();
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 600);
        };

        function updateOrderID() {
            const newId = Math.floor(10000 + Math.random() * 90000);
            document.getElementById('order-id-display').innerText = newId;
        }

        function switchTab(tab) {
            document.getElementById('tab-new').classList.toggle('hidden', tab !== 'new');
            document.getElementById('tab-history').classList.toggle('hidden', tab !== 'history');
        }

        document.getElementById('orderForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            
            btn.innerText = "PROCESANDO ENVÍO...";
            btn.disabled = true;

            const selectedTreatments = Array.from(document.querySelectorAll('.t-check:checked')).map(c => c.value).join(', ') || 'Sin tratamientos';

            // Mapeo exacto según tu plantilla de EmailJS
            const orderData = {
                order_id: document.getElementById('order-id-display').innerText,
                patient_name: document.getElementById('patient_name').value,
                lens_type: document.getElementById('lens_type').value,
                treatments: selectedTreatments,
                date: new Date().toLocaleString('es-AR'),
                notes: document.getElementById('notes').value || 'Ninguna',
                email: CONFIG.MY_EMAIL // Para llenar el campo destinatario si usas {{email}} en EmailJS
            };

            try {
                // Envío directo a EmailJS
                const response = await emailjs.send(CONFIG.SERVICE_ID, CONFIG.TEMPLATE_ID, orderData);
                console.log("EmailJS Success:", response.status, response.text);
                
                // Guardar localmente solo si el envío fue exitoso
                orders.push(orderData);
                localStorage.setItem('optica_v3_data', JSON.stringify(orders));
                
                alert("¡ÉXITO! El pedido se envió correctamente.");
                document.getElementById('orderForm').reset();
                updateOrderID();
                renderHistory();
                switchTab('history');
            } catch (err) {
                console.error("Error EmailJS:", err);
                alert("ERROR: No se pudo enviar el mail. Revisa los IDs de Servicio y Plantilla.");
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        };

        function renderHistory() {
            const container = document.getElementById('history-container');
            container.innerHTML = '';
            
            if (orders.length === 0) {
                container.innerHTML = `<div class="text-center py-20 text-gray-400"><i class="fas fa-box-open text-4xl mb-2"></i><p>No hay pedidos aún.</p></div>`;
                return;
            }

            [...orders].reverse().forEach((o, index) => {
                container.innerHTML += `
                    <div class="glass-card flex justify-between items-center py-4 border-l-4 border-blue-600">
                        <div>
                            <span class="text-[10px] font-black text-blue-600 uppercase">#${o.order_id}</span>
                            <h3 class="font-bold text-gray-800">${o.patient_name}</h3>
                            <p class="text-xs text-gray-500">${o.lens_type} | ${o.date}</p>
                        </div>
                        <button onclick="removeOrder(${orders.length - 1 - index})" class="p-2 text-red-300 hover:text-red-500 transition-colors">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
            });
        }

        function removeOrder(i) {
            if (confirm('¿Desea eliminar este registro del historial?')) {
                orders.splice(i, 1);
                localStorage.setItem('optica_v3_data', JSON.stringify(orders));
                renderHistory();
            }
        }
    </script>
</body>
</html>
