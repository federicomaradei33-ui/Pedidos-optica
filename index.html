<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Pedidos - Óptica Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Librería para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(226, 232, 240, 0.8);
        }

        .input-field {
            @apply w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all outline-none;
        }

        .prescription-grid {
            display: grid;
            grid-template-columns: 100px 1fr 1fr 1fr 1fr;
            gap: 1rem;
            align-items: center;
        }

        #pdf-template {
            padding: 40px;
            background: white;
            color: black;
            width: 800px;
        }
        
        .loading-overlay {
            background: rgba(255, 255, 255, 0.8);
            display: none;
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loader de Sincronización -->
    <div id="loader" class="fixed inset-0 z-[200] flex items-center justify-center loading-overlay">
        <div class="flex flex-col items-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
            <p class="mt-4 font-semibold text-blue-600">Sincronizando con la nube...</p>
        </div>
    </div>

    <!-- Navegación -->
    <nav class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <i class="fas fa-glasses text-blue-600 text-2xl"></i>
                    <span class="font-bold text-xl tracking-tight">Óptica<span class="text-blue-600">Connect</span></span>
                </div>
                <div class="flex gap-4">
                    <button onclick="switchTab('new-order')" class="text-gray-600 hover:text-blue-600 font-medium px-3 py-2">Nuevo Pedido</button>
                    <button onclick="switchTab('history')" class="text-gray-600 hover:text-blue-600 font-medium px-3 py-2 relative">
                        Historial
                        <span id="badge-count" class="hidden absolute top-0 right-0 bg-red-500 text-white text-[10px] px-1.5 rounded-full">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <!-- Tab: Nuevo Pedido -->
        <section id="tab-new-order" class="space-y-6">
            <div class="flex justify-between items-end">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Formulario de Pedido</h1>
                    <p class="text-gray-500">Ingrese los datos para generar la orden y guardarla en la nube.</p>
                </div>
                <div class="text-right">
                    <span class="text-sm text-gray-400">Orden #<span id="order-id-display">--</span></span>
                </div>
            </div>

            <form id="orderForm" class="space-y-6">
                <!-- Paciente -->
                <div class="glass-card p-6 rounded-xl shadow-sm space-y-4">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-user text-blue-500"></i> Datos del Paciente
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nombre Completo</label>
                            <input type="text" id="patientName" name="patient_name" class="input-field" placeholder="Ej: Juan Pérez" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">DNI / ID</label>
                            <input type="text" id="patientId" class="input-field" placeholder="Documento">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Teléfono</label>
                            <input type="tel" id="patientTel" class="input-field" placeholder="+54...">
                        </div>
                    </div>
                </div>

                <!-- Receta Técnica -->
                <div class="glass-card p-6 rounded-xl shadow-sm space-y-6">
                    <h2 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fas fa-microscope text-blue-500"></i> Graduación
                    </h2>
                    
                    <div class="overflow-x-auto">
                        <div class="min-w-[600px] space-y-4">
                            <div class="prescription-grid text-sm font-bold text-gray-500 border-b pb-2">
                                <div>OJO</div>
                                <div>ESFERA</div>
                                <div>CILINDRO</div>
                                <div>EJE</div>
                                <div>ADICIÓN</div>
                            </div>
                            <div class="prescription-grid">
                                <div class="font-bold text-blue-700">DERECHO</div>
                                <input type="number" step="0.25" id="od_esf" class="input-field" placeholder="0.00">
                                <input type="number" step="0.25" id="od_cil" class="input-field" placeholder="0.00">
                                <input type="number" step="1" id="od_eje" class="input-field" placeholder="0°">
                                <input type="number" step="0.25" id="od_add" class="input-field" placeholder="0.00">
                            </div>
                            <div class="prescription-grid">
                                <div class="font-bold text-blue-700">IZQUIERDO</div>
                                <input type="number" step="0.25" id="oi_esf" class="input-field" placeholder="0.00">
                                <input type="number" step="0.25" id="oi_cil" class="input-field" placeholder="0.00">
                                <input type="number" step="1" id="oi_eje" class="input-field" placeholder="0°">
                                <input type="number" step="0.25" id="oi_add" class="input-field" placeholder="0.00">
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-4 border-t">
                        <div>
                            <label class="block text-sm font-medium mb-1">DNP (Distancia Nasopupilar)</label>
                            <input type="text" id="dnp" class="input-field" placeholder="Ej: 32/34 mm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Altura</label>
                            <input type="text" id="altura" class="input-field" placeholder="Ej: 18 mm">
                        </div>
                    </div>
                </div>

                <!-- Detalles de Lente y Armazón -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="glass-card p-6 rounded-xl shadow-sm space-y-4">
                        <h2 class="text-lg font-semibold text-blue-600">Cristales</h2>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tipo de Lente</label>
                            <select id="lensType" class="input-field">
                                <option>Monofocal Stock</option>
                                <option>Monofocal Laboratorio</option>
                                <option>Bifocal</option>
                                <option>Progresivo / Multifocal</option>
                                <option>Ocupacional</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Tratamiento</label>
                            <div class="grid grid-cols-2 gap-2">
                                <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-blue-50">
                                    <input type="checkbox" name="treat" value="Antireflex"> Antireflex
                                </label>
                                <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-blue-50">
                                    <input type="checkbox" name="treat" value="Blue Cut"> Blue Cut
                                </label>
                                <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-blue-50">
                                    <input type="checkbox" name="treat" value="Fotocromático"> Fotocromático
                                </label>
                                <label class="flex items-center gap-2 p-2 border rounded cursor-pointer hover:bg-blue-50">
                                    <input type="checkbox" name="treat" value="Polarizado"> Polarizado
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="glass-card p-6 rounded-xl shadow-sm space-y-4">
                        <h2 class="text-lg font-semibold text-blue-600">Armazón</h2>
                        <div>
                            <label class="block text-sm font-medium mb-1">Origen Armazón</label>
                            <select id="frameSource" class="input-field">
                                <option value="De la Óptica">De la Óptica (Stock)</option>
                                <option value="Del Paciente">Trae el Paciente</option>
                                <option value="Enviar a Taller">Enviar a Laboratorio</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Marca / Modelo / Color</label>
                            <input type="text" id="frameModel" class="input-field" placeholder="Ej: Ray-Ban 5228 Negro">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Observaciones</label>
                            <textarea id="notes" class="input-field h-24" placeholder="Instrucciones especiales para el taller..."></textarea>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end gap-4">
                    <button type="button" onclick="resetForm()" class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-100 font-medium">Limpiar</button>
                    <button type="submit" id="submitBtn" class="px-8 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-lg transition-all flex items-center gap-2">
                        <span id="btnText">GUARDAR Y GENERAR PDF</span>
                        <i class="fas fa-cloud-upload-alt"></i>
                    </button>
                </div>
            </form>
        </section>

        <!-- Tab: Historial -->
        <section id="tab-history" class="hidden space-y-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Historial Global</h1>
                    <p class="text-gray-500">Pedidos sincronizados en la nube.</p>
                </div>
                <div class="flex gap-2">
                    <input type="text" id="searchOrders" oninput="renderHistory()" placeholder="Buscar paciente..." class="input-field w-64">
                </div>
            </div>

            <div class="glass-card rounded-xl overflow-hidden shadow-sm">
                <table class="w-full text-left">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">Orden</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">Fecha</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase">Paciente</th>
                            <th class="px-6 py-3 text-xs font-bold text-gray-500 uppercase text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody" class="divide-y divide-gray-100"></tbody>
                </table>
            </div>
        </section>
    </main>

    <!-- Modal Detalles del Pedido -->
    <div id="detailsModal" class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[150] p-4">
        <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Detalles del Pedido <span id="det-id" class="text-blue-600"></span></h3>
                    <p id="det-date" class="text-sm text-gray-500"></p>
                </div>
                <button onclick="closeDetails()" class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
            </div>
            
            <div class="p-6 overflow-y-auto space-y-6">
                <!-- Paciente Detalle -->
                <div class="grid grid-cols-2 gap-4 bg-blue-50 p-4 rounded-lg">
                    <div>
                        <p class="text-xs uppercase font-bold text-blue-400">Paciente</p>
                        <p id="det-name" class="font-bold text-gray-800 text-lg"></p>
                    </div>
                    <div>
                        <p class="text-xs uppercase font-bold text-blue-400">DNI / Tel</p>
                        <p id="det-id-tel" class="text-gray-700"></p>
                    </div>
                </div>

                <!-- Receta Detalle -->
                <div>
                    <h4 class="font-bold text-gray-900 mb-2 flex items-center gap-2">
                        <i class="fas fa-eye text-blue-500"></i> Graduación
                    </h4>
                    <div class="border rounded-lg overflow-hidden">
                        <table class="w-full text-sm text-center">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th class="py-2 px-1">OJO</th>
                                    <th class="py-2 px-1">ESF</th>
                                    <th class="py-2 px-1">CIL</th>
                                    <th class="py-2 px-1">EJE</th>
                                    <th class="py-2 px-1">ADD</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr class="border-t">
                                    <td class="py-2 font-bold bg-gray-50">OD</td>
                                    <td id="det-od-esf"></td>
                                    <td id="det-od-cil"></td>
                                    <td id="det-od-eje"></td>
                                    <td id="det-od-add"></td>
                                </tr>
                                <tr class="border-t">
                                    <td class="py-2 font-bold bg-gray-50">OI</td>
                                    <td id="det-oi-esf"></td>
                                    <td id="det-oi-cil"></td>
                                    <td id="det-oi-eje"></td>
                                    <td id="det-oi-add"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="flex gap-4 mt-2 text-sm text-gray-600 bg-gray-50 p-2 rounded">
                        <p><strong>DNP:</strong> <span id="det-dnp"></span></p>
                        <p><strong>Altura:</strong> <span id="det-altura"></span></p>
                    </div>
                </div>

                <!-- Cristales y Armazón -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border p-3 rounded-lg">
                        <p class="text-xs font-bold text-blue-500 uppercase mb-1">Cristales</p>
                        <p id="det-lens" class="font-semibold text-gray-800"></p>
                        <p id="det-treat" class="text-sm text-gray-600"></p>
                    </div>
                    <div class="border p-3 rounded-lg">
                        <p class="text-xs font-bold text-blue-500 uppercase mb-1">Armazón</p>
                        <p id="det-frame-src" class="font-semibold text-gray-800"></p>
                        <p id="det-frame-mod" class="text-sm text-gray-600"></p>
                    </div>
                </div>

                <!-- Notas -->
                <div class="border p-3 rounded-lg bg-yellow-50/50">
                    <p class="text-xs font-bold text-gray-500 uppercase mb-1">Observaciones</p>
                    <p id="det-notes" class="text-sm text-gray-700 italic"></p>
                </div>
            </div>

            <div class="p-4 border-t bg-gray-50 flex gap-3">
                <button id="det-download-btn" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-blue-700">
                    <i class="fas fa-file-pdf"></i> Descargar PDF
                </button>
                <button onclick="closeDetails()" class="px-6 py-3 border border-gray-300 rounded-xl font-bold hover:bg-gray-100">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Template PDF (Oculto) -->
    <div style="display: none;">
        <div id="pdf-template">
            <div style="border-bottom: 2px solid #2563eb; padding-bottom: 20px; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="color: #2563eb; font-size: 28px; margin: 0; font-weight: bold;">ORDEN TÉCNICA</h1>
                    <p style="margin: 5px 0; color: #64748b; font-size: 16px;">Óptica Connect - Gestión de Pedidos</p>
                </div>
                <div style="text-align: right;">
                    <p style="font-size: 20px; font-weight: bold; margin: 0;">N°: <span id="pdf-order-id"></span></p>
                    <p id="pdf-date" style="margin: 5px 0; color: #64748b;"></p>
                </div>
            </div>
            <div id="pdf-content-placeholder"></div>
        </div>
    </div>

    <!-- Modal de Éxito al Guardar -->
    <div id="successModal" class="fixed inset-0 bg-black/50 hidden flex items-center justify-center z-[200] p-4">
        <div class="bg-white p-8 rounded-2xl text-center space-y-4 max-w-sm w-full shadow-2xl">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto">
                <i class="fas fa-check text-green-500 text-4xl"></i>
            </div>
            <h3 class="font-bold text-2xl">¡Pedido Guardado!</h3>
            <p class="text-gray-500">Se sincronizó correctamente en la nube.</p>
            <button onclick="closeSuccess()" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold">Aceptar</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, doc, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'pedidos-optica-default';

        let currentUser = null;
        let allOrders = [];

        async function init() {
            document.getElementById('loader').style.display = 'flex';
            try {
                await signInAnonymously(auth);
            } catch (err) { console.error("Auth error:", err); }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const q = collection(db, 'artifacts', appId, 'public', 'data', 'orders');
                onSnapshot(q, (snapshot) => {
                    allOrders = snapshot.docs.map(doc => ({ id_fs: doc.id, ...doc.data() }));
                    allOrders.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                    renderHistory();
                    updateBadge(allOrders.length);
                    document.getElementById('loader').style.display = 'none';
                }, () => document.getElementById('loader').style.display = 'none');
            }
        });

        function updateBadge(count) {
            const badge = document.getElementById('badge-count');
            if (count > 0) {
                badge.innerText = count;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        window.switchTab = (tab) => {
            document.getElementById('tab-new-order').classList.toggle('hidden', tab !== 'new-order');
            document.getElementById('tab-history').classList.toggle('hidden', tab !== 'history');
        };

        window.closeSuccess = () => document.getElementById('successModal').classList.add('hidden');

        window.renderHistory = () => {
            const queryStr = document.getElementById('searchOrders').value.toLowerCase();
            const tbody = document.getElementById('historyTableBody');
            tbody.innerHTML = '';
            
            const filtered = allOrders.filter(o => o.patient.toLowerCase().includes(queryStr));
            
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-6 py-10 text-center text-gray-400">No hay pedidos disponibles</td></tr>';
                return;
            }

            filtered.forEach(o => {
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 font-mono font-bold text-blue-600">#${o.id}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${o.date}</td>
                        <td class="px-6 py-4 font-bold text-gray-800">${o.patient}</td>
                        <td class="px-6 py-4 flex justify-center gap-2">
                            <button onclick="showDetails('${o.id_fs}')" class="bg-blue-50 text-blue-600 hover:bg-blue-100 p-2 rounded-lg transition-colors" title="Ver Detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="downloadFromFS('${o.id_fs}')" class="bg-green-50 text-green-600 hover:bg-green-100 p-2 rounded-lg transition-colors" title="Descargar PDF">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="deleteOrder('${o.id_fs}')" class="bg-red-50 text-red-400 hover:bg-red-100 p-2 rounded-lg transition-colors" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>`;
            });
        };

        window.showDetails = (fsId) => {
            const data = allOrders.find(o => o.id_fs === fsId);
            if (!data) return;

            document.getElementById('det-id').innerText = '#' + data.id;
            document.getElementById('det-date').innerText = data.date;
            document.getElementById('det-name').innerText = data.patient;
            document.getElementById('det-id-tel').innerText = `${data.patientId || '-'} / ${data.patientTel || '-'}`;
            
            document.getElementById('det-od-esf').innerText = data.od.esf || '0.00';
            document.getElementById('det-od-cil').innerText = data.od.cil || '0.00';
            document.getElementById('det-od-eje').innerText = (data.od.eje || '0') + '°';
            document.getElementById('det-od-add').innerText = data.od.add || '0.00';
            
            document.getElementById('det-oi-esf').innerText = data.oi.esf || '0.00';
            document.getElementById('det-oi-cil').innerText = data.oi.cil || '0.00';
            document.getElementById('det-oi-eje').innerText = (data.oi.eje || '0') + '°';
            document.getElementById('det-oi-add').innerText = data.oi.add || '0.00';

            document.getElementById('det-dnp').innerText = data.dnp || '-';
            document.getElementById('det-altura').innerText = data.altura || '-';
            document.getElementById('det-lens').innerText = data.lensType;
            document.getElementById('det-treat').innerText = data.treatments || 'Sin tratamientos';
            document.getElementById('det-frame-src').innerText = data.frameSource;
            document.getElementById('det-frame-mod').innerText = data.frameModel || 'No especificado';
            document.getElementById('det-notes').innerText = data.notes || 'Sin observaciones.';

            document.getElementById('det-download-btn').onclick = () => generatePDF(data);
            document.getElementById('detailsModal').classList.remove('hidden');
        };

        window.closeDetails = () => document.getElementById('detailsModal').classList.add('hidden');

        window.downloadFromFS = (fsId) => {
            const data = allOrders.find(o => o.id_fs === fsId);
            if (data) generatePDF(data);
        };

        window.deleteOrder = async (fsId) => {
            if (confirm('¿Eliminar este pedido de la nube?')) {
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'orders', fsId));
            }
        };

        const form = document.getElementById('orderForm');
        form.onsubmit = async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const btn = document.getElementById('submitBtn');
            btn.disabled = true;
            document.getElementById('loader').style.display = 'flex';

            const treatments = Array.from(document.querySelectorAll('input[name="treat"]:checked')).map(el => el.value);
            const data = {
                id: document.getElementById('order-id-display').innerText,
                date: new Date().toLocaleDateString('es-AR'),
                timestamp: new Date().toISOString(),
                patient: document.getElementById('patientName').value,
                patientId: document.getElementById('patientId').value,
                patientTel: document.getElementById('patientTel').value,
                od: { esf: document.getElementById('od_esf').value, cil: document.getElementById('od_cil').value, eje: document.getElementById('od_eje').value, add: document.getElementById('od_add').value },
                oi: { esf: document.getElementById('oi_esf').value, cil: document.getElementById('oi_cil').value, eje: document.getElementById('oi_eje').value, add: document.getElementById('oi_add').value },
                lensType: document.getElementById('lensType').value,
                treatments: treatments.join(', '),
                dnp: document.getElementById('dnp').value,
                altura: document.getElementById('altura').value,
                frameSource: document.getElementById('frameSource').value,
                frameModel: document.getElementById('frameModel').value,
                notes: document.getElementById('notes').value
            };

            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'orders'), data);
                await generatePDF(data);
                document.getElementById('successModal').classList.remove('hidden');
                resetForm();
            } catch (err) {
                console.error(err);
                alert("Error de conexión con la nube.");
            } finally {
                btn.disabled = false;
                document.getElementById('loader').style.display = 'none';
            }
        };

        async function generatePDF(data) {
            document.getElementById('pdf-order-id').innerText = data.id;
            document.getElementById('pdf-date').innerText = data.date;
            
            const html = `
                <div style="margin-bottom: 25px; border: 1px solid #e2e8f0; border-radius: 8px; padding: 15px; background: #f8fafc;">
                    <h3 style="margin-top: 0; color: #1e40af; font-size: 14px; text-transform: uppercase;">Paciente</h3>
                    <p style="font-size: 18px; font-weight: bold; margin: 5px 0;">${data.patient}</p>
                    <p style="margin: 0; color: #64748b;">ID: ${data.patientId || '-'} | Tel: ${data.patientTel || '-'}</p>
                </div>
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; text-align: center; font-size: 14px;">
                    <tr style="background: #2563eb; color: white;">
                        <th style="border: 1px solid #2563eb; padding: 8px;">OJO</th>
                        <th style="border: 1px solid #2563eb; padding: 8px;">ESFERA</th>
                        <th style="border: 1px solid #2563eb; padding: 8px;">CILINDRO</th>
                        <th style="border: 1px solid #2563eb; padding: 8px;">EJE</th>
                        <th style="border: 1px solid #2563eb; padding: 8px;">ADICIÓN</th>
                    </tr>
                    <tr><td style="border: 1px solid #ddd; padding: 10px; font-weight: bold; background: #f1f5f9;">OD</td><td style="border: 1px solid #ddd;">${data.od.esf || '0.00'}</td><td style="border: 1px solid #ddd;">${data.od.cil || '0.00'}</td><td style="border: 1px solid #ddd;">${data.od.eje || '0'}°</td><td style="border: 1px solid #ddd;">${data.od.add || '0.00'}</td></tr>
                    <tr><td style="border: 1px solid #ddd; padding: 10px; font-weight: bold; background: #f1f5f9;">OI</td><td style="border: 1px solid #ddd;">${data.oi.esf || '0.00'}</td><td style="border: 1px solid #ddd;">${data.oi.cil || '0.00'}</td><td style="border: 1px solid #ddd;">${data.oi.eje || '0'}°</td><td style="border: 1px solid #ddd;">${data.oi.add || '0.00'}</td></tr>
                </table>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                    <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px;">
                        <strong style="color: #2563eb; display: block; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 2px;">LENTES</strong>
                        ${data.lensType}<br>
                        <span style="font-size: 12px; color: #64748b;">Tratamientos: ${data.treatments || 'Ninguno'}</span><br>
                        <span style="font-size: 12px;">DNP: ${data.dnp || '-'} | Alt: ${data.altura || '-'}</span>
                    </div>
                    <div style="border: 1px solid #e2e8f0; padding: 12px; border-radius: 8px;">
                        <strong style="color: #2563eb; display: block; border-bottom: 1px solid #eee; margin-bottom: 5px; padding-bottom: 2px;">ARMAZÓN</strong>
                        ${data.frameSource}<br>
                        <span style="font-size: 12px; color: #64748b;">Modelo: ${data.frameModel || 'No especificado'}</span>
                    </div>
                </div>
                <div style="border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; background: #fffbeb;">
                    <strong style="font-size: 12px; color: #92400e; display: block; margin-bottom: 5px;">OBSERVACIONES TÉCNICAS</strong>
                    <p style="margin: 0; font-size: 13px; line-height: 1.4;">${data.notes || 'Sin notas adicionales.'}</p>
                </div>
            `;
            
            document.getElementById('pdf-content-placeholder').innerHTML = html;
            
            const opt = {
                margin: 0.5,
                filename: `Orden_${data.id}_${data.patient}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            return html2pdf().set(opt).from(document.getElementById('pdf-template')).save();
        }

        window.resetForm = () => {
            form.reset();
            document.getElementById('order-id-display').innerText = Math.floor(10000 + Math.random() * 90000);
        };

        init();
        resetForm();
    </script>
</body>
</html>
